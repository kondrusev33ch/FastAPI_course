<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Messages CRUD — Vue 3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="app" class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <h1 class="text-2xl font-bold">Messages CRUD — Vue 3</h1>
      <div class="flex items-center gap-2">
        <label class="text-sm">Base URL:</label>
        <input v-model.trim="baseUrl" class="px-3 py-2 rounded border border-slate-300 text-sm w-72" />
        <button @click="saveBaseUrl" class="px-3 py-2 rounded bg-slate-900 text-white text-sm">Save</button>
        <button @click="refresh" :disabled="loading.list" class="px-3 py-2 rounded bg-slate-700 text-white text-sm">Обновить</button>
      </div>
    </header>

    <section class="grid lg:grid-cols-3 gap-6">
      <!-- List / table -->
      <div class="lg:col-span-2 bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Сообщения</h2>
          <span class="text-xs text-slate-500" v-if="loading.list">Загрузка…</span>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-slate-600">
                <th class="py-2 pr-3">ID</th>
                <th class="py-2 pr-3">Content</th>
                <th class="py-2 pr-3">Действия</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-200">
              <tr v-if="messages.length === 0">
                <td colspan="3" class="py-4 text-slate-500">Пока пусто</td>
              </tr>
              <tr v-for="m in messages" :key="m.id">
                <td class="py-2 pr-3 font-mono text-slate-600">#{{ m.id }}</td>
                <td class="py-2 pr-3">
                  <div v-if="edit.row === m.id" class="flex gap-2">
                    <input v-model.trim="edit.value" class="flex-1 px-2 py-1 rounded border border-slate-300" />
                    <button @click="submitPut(m.id)" :disabled="loading.put" class="px-2 py-1 rounded bg-indigo-600 text-white">PUT</button>
                    <button @click="submitPatch(m.id)" :disabled="loading.patch" class="px-2 py-1 rounded bg-amber-600 text-white">PATCH</button>
                    <button @click="cancelEdit" class="px-2 py-1 rounded bg-slate-200">Отмена</button>
                  </div>
                  <div v-else>{{ m.content }}</div>
                </td>
                <td class="py-2 pr-3">
                  <div class="flex gap-2">
                    <button @click="startEdit(m)" class="px-2 py-1 rounded bg-slate-100">Изм.</button>
                    <button @click="remove(m.id)" :disabled="loading.del" class="px-2 py-1 rounded bg-rose-600 text-white">Удалить</button>
                    <button @click="copyId(m.id)" class="px-2 py-1 rounded bg-slate-100">ID</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p v-if="msg.text" :class="msg.class" class="mt-3 text-sm">{{ msg.text }}</p>
      </div>

      <!-- Create / Read / Delete by ID -->
      <div class="bg-white rounded-2xl shadow p-4 space-y-4">
        <h2 class="text-lg font-semibold">Операции</h2>

        <div class="space-y-2">
          <label class="text-sm">Создать сообщение</label>
          <textarea v-model.trim="create.content" rows="3" class="w-full px-3 py-2 rounded border border-slate-300" placeholder="Текст..."></textarea>
          <button @click="createMsg" :disabled="loading.post" class="px-3 py-2 rounded bg-emerald-600 text-white">
            <span v-if="loading.post">Создаю…</span><span v-else>Создать</span>
          </button>
        </div>

        <hr class="border-slate-200" />

        <div class="space-y-2">
          <label class="text-sm">Прочитать по ID</label>
          <div class="flex gap-2">
            <input v-model.number="read.id" type="number" class="px-3 py-2 rounded border border-slate-300 w-36" placeholder="ID" />
            <button @click="readById" :disabled="loading.get" class="px-3 py-2 rounded bg-slate-900 text-white">GET</button>
          </div>
          <pre class="bg-slate-50 rounded p-3 text-xs overflow-x-auto min-h-[52px]">{{ read.result }}</pre>
        </div>

        <hr class="border-slate-200" />

        <div class="space-y-2">
          <label class="text-sm">Удалить по ID</label>
          <div class="flex gap-2">
            <input v-model.number="del.id" type="number" class="px-3 py-2 rounded border border-slate-300 w-36" placeholder="ID" />
            <button @click="deleteById" :disabled="loading.del" class="px-3 py-2 rounded bg-rose-600 text-white">DELETE</button>
          </div>
          <p class="text-xs text-slate-600">Удаление безвозвратно</p>
        </div>
      </div>
    </section>

    <footer class="text-center text-xs text-slate-500">© Full CRUD Demo</footer>
  </div>

  <script>
    const { createApp, reactive } = Vue;

    createApp({
      setup() {
        const s = reactive({
          baseUrl: localStorage.getItem('messages_base_url') || 'http://localhost:8000',
          messages: [],
          loading: { list: false, get: false, post: false, put: false, patch: false, del: false },
          msg: { text: '', class: 'text-slate-600' },
          create: { content: '' },
          read: { id: null, result: '' },
          del: { id: null },
          edit: { row: null, value: '' },
        });

        function setMsg(text, ok = true) {
          s.msg.text = text;
          s.msg.class = ok ? 'text-emerald-700' : 'text-rose-700';
          if (text) setTimeout(() => { s.msg.text = ''; }, 3000);
        }

        function buildUrl(path) { return s.baseUrl.replace(/\/$/, '') + path; }

        async function api(path, { method = 'GET', body } = {}) {
          const res = await fetch(buildUrl(path), {
            method,
            headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
            body: body ? JSON.stringify(body) : undefined,
          });
          if (!res.ok) {
            let t = await res.text();
            try { const j = JSON.parse(t); t = j.detail || JSON.stringify(j); } catch {}
            throw new Error(`HTTP ${res.status} — ${t}`);
          }
          return res.status === 204 ? null : res.json();
        }

        async function refresh() {
          try { s.loading.list = true; s.messages = await api('/messages'); }
          catch (e) { setMsg(e.message, false); }
          finally { s.loading.list = false; }
        }

        async function createMsg() {
          if (!s.create.content) return setMsg('Введите текст', false);
          try { s.loading.post = true; const m = await api('/messages', { method: 'POST', body: { content: s.create.content } });
                setMsg(`Создано #${m.id}`); s.create.content = ''; await refresh(); }
          catch (e) { setMsg(e.message, false); }
          finally { s.loading.post = false; }
        }

        async function readById() {
          if (s.read.id == null || Number.isNaN(Number(s.read.id))) { s.read.result = 'Некорректный ID'; return; }
          try { s.loading.get = true; const m = await api(`/messages/${s.read.id}`); s.read.result = JSON.stringify(m, null, 2); }
          catch (e) { s.read.result = e.message; }
          finally { s.loading.get = false; }
        }

        function startEdit(m) { s.edit.row = m.id; s.edit.value = m.content; }
        function cancelEdit() { s.edit.row = null; s.edit.value = ''; }

        async function submitPut(id) {
          if (!s.edit.value) return setMsg('Текст не может быть пустым', false);
          try { s.loading.put = true; await api(`/messages/${id}`, { method: 'PUT', body: { content: s.edit.value } });
                setMsg(`Обновлено (PUT) #${id}`); cancelEdit(); await refresh(); }
          catch (e) { setMsg(e.message, false); }
          finally { s.loading.put = false; }
        }

        async function submitPatch(id) {
          if (!s.edit.value) return setMsg('Текст не может быть пустым', false);
          try { s.loading.patch = true; await api(`/messages/${id}`, { method: 'PATCH', body: { content: s.edit.value } });
                setMsg(`Обновлено (PATCH) #${id}`); cancelEdit(); await refresh(); }
          catch (e) { setMsg(e.message, false); }
          finally { s.loading.patch = false; }
        }

        async function remove(id) {
          if (!confirm(`Удалить сообщение #${id}?`)) return;
          try { s.loading.del = true; await api(`/messages/${id}`, { method: 'DELETE' }); setMsg(`Удалено #${id}`); await refresh(); }
          catch (e) { setMsg(e.message, false); }
          finally { s.loading.del = false; }
        }

        async function deleteById() {
          if (s.del.id == null || Number.isNaN(Number(s.del.id))) return setMsg('Некорректный ID', false);
          await remove(s.del.id); s.del.id = null;
        }

        async function copyId(id) { try { await navigator.clipboard.writeText(String(id)); setMsg('ID скопирован'); } catch {} }
        function saveBaseUrl() { localStorage.setItem('messages_base_url', s.baseUrl); refresh(); }

        // init
        refresh();

        return { ...Vue.toRefs(s), refresh, createMsg, readById, startEdit, cancelEdit, submitPut, submitPatch, remove, deleteById, copyId, saveBaseUrl };
      }
    }).mount('#app');
  </script>
</body>
</html>